<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
    <ModulePrefs title="Simple Tasks List" height="120">
        <Require feature="wave" /> 
    </ModulePrefs>
    <Content type="html">
        <![CDATA[
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>            
            <script src="http://github.com/tzuryby/y/raw/master/tasks.xml.js" type="text/javascript"></script>            
            <script type="text/javascript">
//var tasklist = window.tasklist = {};

var newId = function () { 
    lastId = wave.getState().get('lastTaskId', 0);
    return lastId+1;
};

var Task = function() { return {'title': '', 'done': 0, 'id': newId()}; };
var TaskList = function(){ return wave.getState().get('taskList', {});};

var addNew = function (newTask){ 
    alert("addNewCalled");
    list = TaskList();
    list[newTask.taskId] = newTask;
    wave.getState().submitDelta({'taskList': list});    
};

var Delete = function (taskId) { 
    alert("DeleteCalled");
    list = TaskList()
    delete TaskList()[taskId];
    wave.getState().submitDelta({'taskList': list});
};

var RenderList = function(){ 
    alert("RenderCalled");
    $.each(Tasklist(), function(k,v){
        var newNode = $(
            "<div class='task'>" 
            + v.title 
            + "</div>"
        );
        $("#taskList").append(newNode);
    });
};


function addNewTaskHandler(){    
    var task = Task();
    task.title = $("#newTaskTitle").val();
    addNew(task);
    alert(".click called");
}
//$("#addNewLink").click(addNewTaskHandler);

function init() {
  if (wave && wave.isInWaveContainer()) {
    wave.setStateCallback(RenderList);
  }
  else {
    alert ("wave is not initialized");
  }
}
                /*  wave initialisation and registration  */
                gadgets.util.registerOnLoadHandler(init);

            </script>
            <div id="taskList"></div>
            <hr />
            <div class=newTask">
                <h3>Add New Task</h3>
                <input type="text" id="newTaskTitle" value="type here" /> <a href="#" id="addNewLink" onClick="addNewTaskHandler()">Add</a>
            </div>
        ]]> 
    </Content>
</Module>